{% extends "base.html" %}

{% block title %}Editar {{ part.name }} - SAMAPE{% endblock %}

{% block content %}
<!-- Mobile Page Header -->
<div class="mobile-page-header">
    <div class="mobile-header-content">
        <h1 class="mobile-page-title">
            <i class="fas fa-edit me-2"></i>Editar Peça
        </h1>
        <div class="mobile-header-actions">
            <!-- Desktop Actions -->
            <div class="d-none d-md-flex">
                <a href="{{ url_for('parts') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i> Voltar para Lista
                </a>
                <a href="{{ url_for('view_part', id=part.id) }}" class="btn btn-info">
                    <i class="fas fa-eye me-1"></i> Visualizar
                </a>
            </div>
            
            <!-- Mobile Actions -->
            <div class="d-md-none">
                <a href="{{ url_for('view_part', id=part.id) }}" class="mobile-action-btn">
                    <i class="fas fa-eye"></i>
                </a>
                <a href="{{ url_for('parts') }}" class="mobile-action-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-edit me-1"></i> Edição de Peça: <strong>{{ part.name }}</strong>
    </div>
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="name" class="form-label">Nome da Peça *</label>
                    {{ form.name(class="form-control", id="name") }}
                    {% if form.name.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.name.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="part_number" class="form-label">Código/Número da Peça</label>
                    {{ form.part_number(class="form-control", id="part_number") }}
                    {% if form.part_number.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.part_number.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="supplier_id" class="form-label">Fornecedor</label>
                    {{ form.supplier_id(class="form-select", id="supplier_id") }}
                    {% if form.supplier_id.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.supplier_id.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="category" class="form-label">Categoria</label>
                    {{ form.category(class="form-select", id="category") }}
                    {% if form.category.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.category.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="subcategory" class="form-label">Subcategoria</label>
                    {{ form.subcategory(class="form-control", id="subcategory") }}
                    {% if form.subcategory.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.subcategory.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="cost_price" class="form-label">Preço de Custo (R$)</label>
                    {{ form.cost_price(class="form-control", id="cost_price", type="number", step="0.01", min="0") }}
                    {% if form.cost_price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.cost_price.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="selling_price" class="form-label">Preço de Venda (R$)</label>
                    {{ form.selling_price(class="form-control", id="selling_price", type="number", step="0.01", min="0") }}
                    {% if form.selling_price.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.selling_price.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="location" class="form-label">Localização no Estoque</label>
                    {{ form.location(class="form-control", id="location", placeholder="Ex: Prateleira A3, Gaveta 2") }}
                    {% if form.location.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.location.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="stock_quantity" class="form-label">Quantidade em Estoque</label>
                    {{ form.stock_quantity(class="form-control", id="stock_quantity", type="number", min="0") }}
                    {% if form.stock_quantity.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.stock_quantity.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="minimum_stock" class="form-label">Estoque Mínimo</label>
                    {{ form.minimum_stock(class="form-control", id="minimum_stock", type="number", min="0") }}
                    {% if form.minimum_stock.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.minimum_stock.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">Quando o estoque ficar abaixo deste valor, um alerta será exibido.</div>
                </div>
                
                <div class="col-md-4">
                    <div class="form-check form-switch mt-4">
                        {{ form.is_active(class="form-check-input", id="is_active") }}
                        <label class="form-check-label" for="is_active">
                            Peça ativa no sistema
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="image" class="form-label">Nova Imagem da Peça</label>
                    {{ form.image(class="form-control", id="image") }}
                    {% if form.image.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.image.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    <div class="form-text text-muted">Aceita apenas imagens nos formatos JPG, JPEG e PNG. Deixe vazio para manter a imagem atual.</div>
                </div>
                
                <div class="col-md-6">
                    {% if part.image_data %}
                        <label class="form-label">Imagem Atual</label>
                        <div class="border rounded p-2 text-center" style="max-height: 150px; overflow: hidden;">
                            <img src="data:image/png;base64,{{ part.image_data }}" 
                                 alt="{{ part.name }}" 
                                 class="img-fluid"
                                 style="max-height: 120px;">
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="remove_image" name="remove_image">
                            <label class="form-check-label text-danger" for="remove_image">
                                Remover imagem atual
                            </label>
                        </div>
                    {% else %}
                        <div class="text-muted mt-4">
                            <i class="fas fa-image fa-2x"></i>
                            <p>Nenhuma imagem cadastrada</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="description" class="form-label">Descrição da Peça</label>
                {{ form.description(class="form-control", id="description", rows=4) }}
                {% if form.description.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.description.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="mb-3">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Salvar Alterações
                </button>
                <a href="{{ url_for('view_part', id=part.id) }}" class="btn btn-secondary ms-2">
                    <i class="fas fa-times me-1"></i> Cancelar
                </a>
                <a href="{{ url_for('parts') }}" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-list me-1"></i> Voltar para Lista
                </a>
            </div>
        </form>
    </div>
</div>

{% if part.created_at %}
<div class="card mt-4">
    <div class="card-body">
        <div class="row text-muted small">
            <div class="col-md-6">
                <i class="fas fa-calendar-plus me-1"></i>
                <strong>Cadastrado em:</strong> {{ part.created_at.strftime('%d/%m/%Y às %H:%M') }}
            </div>
            {% if part.updated_at %}
            <div class="col-md-6">
                <i class="fas fa-calendar-edit me-1"></i>
                <strong>Última atualização:</strong> {{ part.updated_at.strftime('%d/%m/%Y às %H:%M') }}
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Calcular margem de lucro automaticamente
document.addEventListener('DOMContentLoaded', function() {
    const costPrice = document.getElementById('cost_price');
    const sellingPrice = document.getElementById('selling_price');
    
    function calculateMargin() {
        const cost = parseFloat(costPrice.value) || 0;
        const sale = parseFloat(sellingPrice.value) || 0;
        
        if (cost > 0 && sale > 0) {
            const margin = ((sale - cost) / cost * 100).toFixed(1);
            const marginColor = margin > 0 ? 'success' : (margin < 0 ? 'danger' : 'secondary');
            
            // Remover alertas de margem anteriores
            const existingAlert = document.getElementById('margin-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Criar novo alerta de margem
            const alert = document.createElement('div');
            alert.id = 'margin-alert';
            alert.className = `alert alert-${marginColor} mt-2`;
            alert.innerHTML = `<i class="fas fa-calculator me-1"></i> <strong>Margem de lucro:</strong> ${margin}%`;
            
            sellingPrice.parentNode.appendChild(alert);
        }
    }
    
    if (costPrice && sellingPrice) {
        costPrice.addEventListener('input', calculateMargin);
        sellingPrice.addEventListener('input', calculateMargin);
        
        // Calcular na inicialização se já houver valores
        calculateMargin();
    }
});
</script>
{% endblock %}
