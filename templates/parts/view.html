{% extends "base.html" %}

{% block title %}{{ part.name }} - SAMAPE{% endblock %}

{% block content %}
<!-- Mobile Page Header -->
<div class="mobile-page-header">
    <div class="mobile-header-content">
        <h1 class="mobile-page-title">
            <i class="fas fa-cog me-2"></i>Detalhes da Peça
        </h1>
        <div class="mobile-header-actions">
            <!-- Desktop Actions -->
            <div class="d-none d-md-flex">
                <a href="{{ url_for('parts') }}" class="btn btn-secondary me-2">
                    <i class="fas fa-arrow-left me-1"></i> Voltar
                </a>
                <a href="{{ url_for('edit_part', id=part.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit me-1"></i> Editar
                </a>
            </div>
            
            <!-- Mobile Actions -->
            <div class="d-md-none">
                <a href="{{ url_for('edit_part', id=part.id) }}" class="mobile-action-btn">
                    <i class="fas fa-edit"></i>
                </a>
                <a href="{{ url_for('parts') }}" class="mobile-action-btn">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Informações da Peça -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-info-circle me-1"></i> Informações Gerais
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>{{ part.name }}</h5>
                        {% if part.part_number %}
                            <p><strong>Código:</strong> <code>{{ part.part_number }}</code></p>
                        {% endif %}
                        {% if part.description %}
                            <p><strong>Descrição:</strong> {{ part.description }}</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if part.category %}
                            <p><strong>Categoria:</strong> <span class="badge bg-secondary">{{ part.category }}</span></p>
                        {% endif %}
                        <p><strong>Status:</strong> 
                            {% if part.is_active %}
                                <span class="badge bg-success">Ativo</span>
                            {% else %}
                                <span class="badge bg-secondary">Inativo</span>
                            {% endif %}
                        </p>
                        <p><strong>Cadastrado em:</strong> {{ part.created_at.strftime('%d/%m/%Y às %H:%M') }}</p>
                        {% if part.updated_at %}
                            <p><strong>Última atualização:</strong> {{ part.updated_at.strftime('%d/%m/%Y às %H:%M') }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações Financeiras -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-dollar-sign me-1"></i> Informações Financeiras
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Preço de Custo</h6>
                            {% if part.cost_price %}
                                <h4 class="text-warning">R$ {{ "%.2f"|format(part.cost_price) }}</h4>
                            {% else %}
                                <h4 class="text-muted">-</h4>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Preço de Venda</h6>
                            {% if part.sale_price %}
                                <h4 class="text-success">R$ {{ "%.2f"|format(part.sale_price) }}</h4>
                            {% else %}
                                <h4 class="text-muted">-</h4>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Margem de Lucro</h6>
                            {% if part.cost_price and part.sale_price and part.cost_price > 0 %}
                                {% set margin = ((part.sale_price - part.cost_price) / part.cost_price * 100) %}
                                <h4 class="{% if margin > 0 %}text-success{% elif margin < 0 %}text-danger{% else %}text-muted{% endif %}">
                                    {{ "%.1f"|format(margin) }}%
                                </h4>
                            {% else %}
                                <h4 class="text-muted">-</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informações de Estoque -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-boxes me-1"></i> Controle de Estoque
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Quantidade em Estoque</h6>
                            {% if part.stock_quantity is not none %}
                                {% if part.minimum_stock and part.stock_quantity <= part.minimum_stock %}
                                    <h4 class="text-danger">{{ part.stock_quantity }}</h4>
                                    <small class="text-danger"><i class="fas fa-exclamation-triangle"></i> Estoque baixo</small>
                                {% elif part.stock_quantity <= 5 %}
                                    <h4 class="text-warning">{{ part.stock_quantity }}</h4>
                                    <small class="text-warning">Estoque limitado</small>
                                {% else %}
                                    <h4 class="text-success">{{ part.stock_quantity }}</h4>
                                {% endif %}
                            {% else %}
                                <h4 class="text-muted">-</h4>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Estoque Mínimo</h6>
                            {% if part.minimum_stock %}
                                <h4>{{ part.minimum_stock }}</h4>
                            {% else %}
                                <h4 class="text-muted">-</h4>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Localização</h6>
                            {% if part.location %}
                                <h4>{{ part.location }}</h4>
                            {% else %}
                                <h4 class="text-muted">Não definida</h4>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Fornecedor -->
        {% if part.supplier %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-truck me-1"></i> Fornecedor
            </div>
            <div class="card-body">
                <h6><strong>{{ part.supplier.name }}</strong></h6>
                {% if part.supplier.contact %}
                    <p><i class="fas fa-user me-1"></i> {{ part.supplier.contact }}</p>
                {% endif %}
                {% if part.supplier.phone %}
                    <p><i class="fas fa-phone me-1"></i> 
                        <a href="tel:{{ part.supplier.phone }}">{{ part.supplier.phone }}</a>
                    </p>
                {% endif %}
                {% if part.supplier.email %}
                    <p><i class="fas fa-envelope me-1"></i> 
                        <a href="mailto:{{ part.supplier.email }}">{{ part.supplier.email }}</a>
                    </p>
                {% endif %}
                <a href="{{ url_for('view_supplier', id=part.supplier.id) }}" class="btn btn-sm btn-outline-primary">
                    Ver detalhes do fornecedor
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Imagem da Peça -->
        {% if part.image_data %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-image me-1"></i> Imagem
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ part.image_data }}" 
                     alt="{{ part.name }}" 
                     class="img-fluid rounded"
                     style="max-height: 300px;">
            </div>
        </div>
        {% endif %}

        <!-- Ações -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-cogs me-1"></i> Ações
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('edit_part', id=part.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-1"></i> Editar Peça
                    </a>
                    {% if part.is_active %}
                        <button type="button" class="btn btn-warning" onclick="toggleStatus({{ part.id }}, false)">
                            <i class="fas fa-pause me-1"></i> Desativar
                        </button>
                    {% else %}
                        <button type="button" class="btn btn-success" onclick="toggleStatus({{ part.id }}, true)">
                            <i class="fas fa-play me-1"></i> Ativar
                        </button>
                    {% endif %}
                    <button type="button" class="btn btn-danger" onclick="confirmDelete({{ part.id }}, '{{ part.name }}')">
                        <i class="fas fa-trash me-1"></i> Excluir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Histórico de Vendas (se existir) -->
{% if sales_history %}
<div class="card mt-4">
    <div class="card-header">
        <i class="fas fa-chart-line me-1"></i> Histórico de Vendas
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Quantidade</th>
                        <th>Valor Unitário</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in sales_history %}
                    <tr>
                        <td>{{ sale.date.strftime('%d/%m/%Y') }}</td>
                        <td>{{ sale.client_name or 'Cliente não informado' }}</td>
                        <td>{{ sale.quantity }}</td>
                        <td>R$ {{ "%.2f"|format(sale.unit_price) }}</td>
                        <td>R$ {{ "%.2f"|format(sale.total_price) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function confirmDelete(partId, partName) {
    if (confirm('Tem certeza que deseja excluir a peça "' + partName + '"?')) {
        // Criar form para DELETE
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/pecas/' + partId + '/delete';
        
        // CSRF token
        var csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrf_token';
            input.value = csrfToken.getAttribute('content');
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

function toggleStatus(partId, newStatus) {
    var action = newStatus ? 'ativar' : 'desativar';
    var statusText = newStatus ? 'ativada' : 'desativada';
    
    if (confirm('Tem certeza que deseja ' + action + ' esta peça?')) {
        // Criar form para toggle status
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/pecas/' + partId + '/toggle-status';
        
        // Status
        var statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'is_active';
        statusInput.value = newStatus;
        form.appendChild(statusInput);
        
        // CSRF token
        var csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrf_token';
            input.value = csrfToken.getAttribute('content');
            form.appendChild(input);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
