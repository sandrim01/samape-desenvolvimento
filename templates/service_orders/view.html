
{% extends "base.html" %}
{% block title %}Ordem de Serviço #{{ order.id }} - SAMAPE{% endblock %}
{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4">
    <h1 class="page-title">Ordem de Serviço #{{ order.id }}</h1>
    <div class="d-flex align-items-center ms-auto">
        <button type="button" class="btn btn-primary me-2" onclick="openEditModal({{ order.id }})">
            <i class="fas fa-edit"></i> Editar
        </button>
        <div class="btn-group me-2" role="group">
            <a href="{{ url_for('export_service_order_pdf', id=order.id) }}" class="btn btn-success" target="_blank">
                <i class="fas fa-file-pdf"></i> PDF
            </a>
            <a href="{{ url_for('export_service_order_pdf', id=order.id) }}" 
               class="btn btn-success" 
               id="btnDownloadOSPDF" 
               data-order-id="{{ order.id }}"
               data-client-name="{{ order.client.name if order.client else 'Cliente' }}"
               data-client-phone="{{ order.client.phone if order.client and order.client.phone else '' }}"
               data-description="{{ (order.description or order.service_details or 'Ordem de Serviço')[:50] }}"
               onclick="openWhatsAppAfterOSDownload(event, this)">
                <i class="fab fa-whatsapp"></i> WhatsApp
            </a>
            <a href="{{ url_for('print_service_order', id=order.id) }}" class="btn btn-outline-success" target="_blank">
                <i class="fas fa-print"></i> Imprimir
            </a>
        </div>
        {% if current_user.role.name == 'admin' %}
        <form method="POST" action="{{ url_for('delete_service_order', id=order.id) }}" style="display: inline;" onsubmit="return confirm('Tem certeza que deseja excluir esta ordem de serviço? Esta ação não pode ser desfeita.')">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-danger me-2">
                <i class="fas fa-trash-alt"></i> Excluir
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('service_orders') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para Lista
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <!-- Dados da Ordem de Serviço -->
        <div class="card mb-4">
            <div class="card-header py-3 bg-gradient-primary">
                <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-clipboard-list me-1"></i> Dados da OS</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="fw-bold">Descrição</h6>
                    <p class="text-pre-wrap">{{ order.description or order.service_details or '-' }}</p>
                </div>
                
                {% if order.parts_list_number %}
                <div class="mb-3">
                    <h6 class="fw-bold"><i class="fas fa-list-alt me-1"></i> Listagem de Peças</h6>
                    <p>
                        <span class="badge bg-info">{{ order.parts_list_number }}</span>
                        {% if order.parts_lists %}
                            <a href="{{ url_for('view_parts_list', id=order.parts_lists[0].id) }}" class="btn btn-sm btn-outline-primary ms-2">
                                <i class="fas fa-eye"></i> Ver Listagem
                            </a>
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <h6 class="fw-bold">Status</h6>
                    <p><span class="badge bg-{% if order.status and hasattr(order.status, 'name') and order.status.name == 'aberta' %}warning{% elif order.status and hasattr(order.status, 'name') and order.status.name == 'em_andamento' %}primary{% elif order.status and hasattr(order.status, 'name') and order.status.name == 'fechada' %}success{% else %}danger{% endif %}">{{ order.status.value if order.status and hasattr(order.status, 'value') else 'N/A' }}</span></p>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Cliente</h6>
                    <p>{% if order.client %}<a href="{{ url_for('view_client', id=order.client.id) }}">{{ order.client.name }}</a>{% else %}Cliente não definido{% endif %}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Data de Criação</h6>
                    <p>{{ order.created_at.strftime('%d/%m/%Y') if order.created_at else '-' }}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Telefone do Cliente</h6>
                    <p>{{ order.client.phone or 'Não informado' }}</p>
                </div>
                
                <div class="mb-3">
                    <h6 class="fw-bold">Responsável</h6>
                    <p>{{ order.responsible.name if order.responsible else 'Não definido' }}</p>
                </div>
                
                {% if order.closed_at %}
                <div class="mb-3">
                    <h6 class="fw-bold">Data de Fechamento</h6>
                    <p>{{ order.closed_at.strftime('%d/%m/%Y') }}</p>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <h6 class="fw-bold">Valor</h6>
                    {% if order.invoice_amount %}
                        <p class="fw-bold text-success">Faturado: R$ {{ '%.2f'|format(order.invoice_amount) }}</p>
                    {% endif %}
                    {% if order.total_value is not none %}
                        <p class="fw-bold text-primary">Total Calculado: R$ {{ '%.2f'|format(order.total_value) }}</p>
                    {% endif %}
                    {% if order.estimated_value %}
                        <p class="fw-bold text-info">Estimado: R$ {{ '%.2f'|format(order.estimated_value) }}</p>
                    {% endif %}
                    {% if not order.invoice_amount and order.total_value is none and not order.estimated_value %}
                        <p class="text-muted">Valor não definido</p>
                    {% endif %}
                </div>
                
                <!-- Kilometragem e Valores Detalhados -->
                {% if order.km_inicial is not none or order.km_final is not none or order.labor_value is not none or order.parts_value is not none %}
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="fas fa-calculator me-1"></i> Detalhamento de Valores</h6>
                        
                        <!-- Kilometragem -->
                        {% if order.km_inicial is not none or order.km_final is not none %}
                        <div class="mb-3 pb-3 border-bottom">
                            <h6 class="text-primary mb-2"><i class="fas fa-tachometer-alt me-1"></i> Kilometragem</h6>
                            <div class="row">
                                {% if order.km_inicial is not none %}
                                <div class="col-6">
                                    <small class="text-muted">KM Inicial</small>
                                    <p class="mb-1">{{ '%.2f'|format(order.km_inicial) }} km</p>
                                </div>
                                {% endif %}
                                {% if order.km_final is not none %}
                                <div class="col-6">
                                    <small class="text-muted">KM Final</small>
                                    <p class="mb-1">{{ '%.2f'|format(order.km_final) }} km</p>
                                </div>
                                {% endif %}
                            </div>
                            {% if order.km_total is not none and order.km_total > 0 %}
                            <div class="row mt-2">
                                <div class="col-6">
                                    <small class="text-muted">Total Percorrido</small>
                                    <p class="mb-1 fw-bold text-primary">{{ '%.2f'|format(order.km_total) }} km</p>
                                </div>
                                {% if order.km_rate is not none %}
                                <div class="col-6">
                                    <small class="text-muted">Valor por KM</small>
                                    <p class="mb-1">R$ {{ '%.2f'|format(order.km_rate) }}</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if order.km_value is not none %}
                            <div class="row mt-2 pt-2 border-top">
                                <div class="col-12">
                                    <small class="text-muted">Valor Total KM</small>
                                    <p class="mb-0 fw-bold text-success">R$ {{ '%.2f'|format(order.km_value) }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        <!-- Valores do Serviço -->
                        {% if order.labor_value is not none or order.parts_value is not none or order.km_value is not none %}
                        <div class="mb-2">
                            <h6 class="text-success mb-2"><i class="fas fa-dollar-sign me-1"></i> Composição de Valores</h6>
                            <div class="row">
                                {% if order.km_value is not none %}
                                <div class="col-6 mb-2">
                                    <small class="text-muted">Valor KM</small>
                                    <p class="mb-0">R$ {{ '%.2f'|format(order.km_value) }}</p>
                                </div>
                                {% endif %}
                                {% if order.labor_value is not none %}
                                <div class="col-6 mb-2">
                                    <small class="text-muted">Mão de Obra</small>
                                    <p class="mb-0">R$ {{ '%.2f'|format(order.labor_value) }}</p>
                                </div>
                                {% endif %}
                                {% if order.parts_value is not none %}
                                <div class="col-6 mb-2">
                                    <small class="text-muted">Peças</small>
                                    <p class="mb-0">R$ {{ '%.2f'|format(order.parts_value) }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if order.status and hasattr(order.status, 'name') and order.status.name == 'fechada' and order.invoice_number %}
                <div class="mb-3">
                    <h6 class="fw-bold">Nota Fiscal</h6>
                    <p><a href="{{ url_for('view_invoice', id=order.id) }}" class="btn btn-sm btn-outline-info">{{ order.invoice_number }}</a></p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <!-- Equipamentos -->
        <div class="card mb-4">
            <div class="card-header py-3 bg-gradient-primary d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-tools me-1"></i> Equipamentos</h6>
                <a href="{{ url_for('new_equipment') }}?client_id={{ order.client.id }}" class="btn btn-sm btn-light">
                    <i class="fas fa-plus me-1"></i> Adicionar Equipamento
                </a>
            </div>
            <div class="card-body">
                {% if order.equipment %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Nº Série</th>
                                <th>Ano</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equip in order.equipment %}
                            <tr>
                                <td>{{ equip.type }}</td>
                                <td>{{ equip.brand or '-' }}</td>
                                <td>{{ equip.model or '-' }}</td>
                                <td>{{ equip.serial_number or '-' }}</td>
                                <td>{{ equip.year or '-' }}</td>
                                <td class="table-actions">
                                    <a href="{{ url_for('view_equipment', id=equip.id) }}" class="btn btn-sm btn-outline-primary" data-bs-toggle="tooltip" data-bs-placement="top" title="Visualizar">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center my-4">Nenhum equipamento vinculado a esta OS.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Lançamentos Financeiros -->
        {% if order.financial_entries %}
        <div class="card">
            <div class="card-header py-3 bg-gradient-primary d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-white"><i class="fas fa-cash-register me-1"></i> Lançamentos Financeiros</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for entry in order.financial_entries %}
                            <tr>
                                <td>{{ entry.date.strftime('%d/%m/%Y') if entry.date else 'N/A' }}</td>
                                <td>{{ entry.description }}</td>
                                <td class="{% if entry.type and hasattr(entry.type, 'name') and entry.type.name == 'entrada' %}text-success{% else %}text-danger{% endif %}">R$ {{ '%.2f'|format(entry.amount) }}</td>
                                <td><span class="badge bg-{% if entry.type and hasattr(entry.type, 'name') and entry.type.name == 'entrada' %}success{% else %}danger{% endif %}">{{ entry.type.value if entry.type and hasattr(entry.type, 'value') else 'N/A' }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para Editar Ordem de Serviço -->
<div class="modal fade" id="editServiceOrderModal" tabindex="-1" aria-labelledby="editServiceOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editServiceOrderModalLabel">
                    <i class="fas fa-edit me-2"></i>Editar Ordem de Serviço
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body" id="editModalBodyContent">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="saveOrderBtn" onclick="saveServiceOrder()">
                    <i class="fas fa-save me-1"></i>Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Carregamento obrigatório do jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script class="requires-jquery">
let currentOrderId = null;

// Aguardar o carregamento do jQuery antes de executar
function initializeModal() {
    if (typeof $ === 'undefined') {
        setTimeout(initializeModal, 100);
        return;
    }
    
    console.log('jQuery carregado e modal inicializado na página view');
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeModal);
} else {
    initializeModal();
}

// Função para abrir modal de edição
function openEditModal(orderId) {
    console.log('openEditModal chamado com ID:', orderId);
    
    // Verificar se jQuery está disponível
    if (typeof $ === 'undefined') {
        console.error('jQuery não está carregado');
        return;
    }
    
    currentOrderId = orderId;
    
    // Abrir modal de edição
    const editModal = new bootstrap.Modal(document.getElementById('editServiceOrderModal'));
    editModal.show();
    
    // Resetar conteúdo do modal
    $('#editModalBodyContent').html(`
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        </div>
    `);
    
    // Buscar dados da OS para edição via AJAX
    console.log('Fazendo requisição AJAX para:', '/os/' + orderId + '/edit-modal');
    $.ajax({
        url: '/os/' + orderId + '/edit-modal',
        method: 'GET',
        dataType: 'json',
        timeout: 10000,
        success: function(data) {
            console.log('Dados recebidos para edição:', data);
            renderEditModal(data);
        },
        error: function(xhr, status, error) {
            console.error('Erro na requisição AJAX:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });
            $('#editModalBodyContent').html(`
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Erro ao carregar formulário de edição:</strong><br>
                    Status: ${xhr.status}<br>
                    Erro: ${error}<br>
                    Resposta: ${xhr.responseText || 'Nenhuma resposta'}
                </div>
            `);
        }
    });
}

// Função para renderizar formulário de edição (copiada da index.html)
function renderEditModal(data) {
    console.log('renderEditModal chamado com dados:', data);
    
    if (!data) {
        console.error('Dados da ordem não fornecidos para edição');
        return;
    }
    
    // Gerar opções para clientes
    const clientOptions = data.clients.map(client => 
        `<option value="${client.id}" ${client.id === data.client_id ? 'selected' : ''}>${client.name}</option>`
    ).join('');
    
    // Gerar opções para responsáveis
    const userOptions = '<option value="0" ' + (data.responsible_id === 0 ? 'selected' : '') + '>A ser definido</option>' +
        data.users.map(user => 
            `<option value="${user.id}" ${user.id === data.responsible_id ? 'selected' : ''}>${user.name}</option>`
        ).join('');
    
    // Gerar checkboxes para equipamentos
    const equipmentCheckboxes = data.equipment.map(equipment => `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="${equipment.id}" id="equipment_${equipment.id}"
                   ${data.equipment_ids.includes(equipment.id) ? 'checked' : ''}>
            <label class="form-check-label" for="equipment_${equipment.id}">
                ${equipment.model} - ${equipment.brand}
            </label>
        </div>
    `).join('');
    
    const editFormContent = `
        <form id="editServiceOrderForm">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="edit_client_id" class="form-label">Cliente *</label>
                        <select class="form-select" id="edit_client_id" required>
                            <option value="">Selecione um cliente</option>
                            ${clientOptions}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="edit_responsible_id" class="form-label">Responsável</label>
                        <select class="form-select" id="edit_responsible_id">
                            ${userOptions}
                        </select>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="mb-3">
                        <label for="edit_description" class="form-label">Descrição *</label>
                        <textarea class="form-control" id="edit_description" rows="3" required>${data.description}</textarea>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="edit_estimated_value" class="form-label">Valor Estimado</label>
                        <input type="number" class="form-control" id="edit_estimated_value" step="0.01" value="${data.estimated_value}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="edit_km_inicial" class="form-label">KM Inicial</label>
                        <input type="number" class="form-control" id="edit_km_inicial" step="0.01" value="${data.km_inicial}">
                    </div>
                </div>
                
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="edit_km_final" class="form-label">KM Final</label>
                        <input type="number" class="form-control" id="edit_km_final" step="0.01" value="${data.km_final}">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="edit_status" class="form-label">Status</label>
                        <select class="form-select" id="edit_status">
                            <option value="aberta" ${data.status === 'aberta' ? 'selected' : ''}>Aberta</option>
                            <option value="em_andamento" ${data.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="fechada" ${data.status === 'fechada' ? 'selected' : ''}>Fechada</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="mb-3">
                        <label for="edit_service_details" class="form-label">Detalhes do Serviço</label>
                        <textarea class="form-control" id="edit_service_details" rows="3">${data.service_details}</textarea>
                    </div>
                </div>
                
                <div class="col-12">
                    <div class="mb-3">
                        <label class="form-label">Equipamentos</label>
                        <div class="equipment-checkboxes" style="max-height: 200px; overflow-y: auto;">
                            ${equipmentCheckboxes}
                        </div>
                    </div>
                </div>
            </div>
        </form>
    `;
    
    $('#editModalBodyContent').html(editFormContent);
}

// Função para salvar alterações da OS (copiada da index.html)
function saveServiceOrder() {
    console.log('saveServiceOrder chamado');
    
    if (!currentOrderId) {
        console.error('ID da ordem não definido');
        return;
    }
    
    // Coletar dados do formulário
    const clientIdValue = $('#edit_client_id').val();
    const responsibleIdValue = $('#edit_responsible_id').val();
    const descriptionValue = $('#edit_description').val();
    const estimatedValue = $('#edit_estimated_value').val();
    const kmInicialValue = $('#edit_km_inicial').val();
    const kmFinalValue = $('#edit_km_final').val();
    const statusValue = $('#edit_status').val();
    const serviceDetailsValue = $('#edit_service_details').val();
    
    console.log('Valores coletados do formulário:', {
        clientIdValue,
        responsibleIdValue,
        descriptionValue,
        estimatedValue,
        kmInicialValue,
        kmFinalValue,
        statusValue,
        serviceDetailsValue
    });
    
    const formData = {
        client_id: clientIdValue ? parseInt(clientIdValue) : null,
        responsible_id: responsibleIdValue ? parseInt(responsibleIdValue) : 0,
        description: descriptionValue || '',
        estimated_value: estimatedValue ? parseFloat(estimatedValue) : null,
        km_inicial: kmInicialValue ? parseFloat(kmInicialValue) : null,
        km_final: kmFinalValue ? parseFloat(kmFinalValue) : null,
        status: statusValue || 'aberta',
        service_details: serviceDetailsValue || '',
        equipment_ids: []
    };
    
    // Coletar equipamentos selecionados
    $('.equipment-checkboxes input[type="checkbox"]:checked').each(function() {
        formData.equipment_ids.push(parseInt($(this).val()));
    });
    
    console.log('Dados finais para salvar:', formData);
    
    // Validações básicas
    if (!formData.client_id || isNaN(formData.client_id)) {
        alert('Por favor, selecione um cliente válido.');
        return;
    }
    
    if (!formData.description || !formData.description.trim()) {
        alert('Por favor, informe uma descrição.');
        return;
    }
    
    // Desabilitar botão de salvar
    $('#saveOrderBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Salvando...');
    
    // Enviar dados via AJAX
    $.ajax({
        url: '/os/' + currentOrderId + '/update-ajax',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            console.log('Resposta da atualização:', response);
            
            if (response.success) {
                // Fechar modal
                $('#editServiceOrderModal').modal('hide');
                
                // Mostrar mensagem de sucesso
                alert(response.message || 'Ordem de serviço atualizada com sucesso!');
                
                // Recarregar página para mostrar alterações
                window.location.reload();
            } else {
                alert('Erro: ' + (response.error || 'Erro desconhecido'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Erro ao salvar:', {
                status: xhr.status,
                statusText: xhr.statusText,
                responseText: xhr.responseText,
                error: error
            });
            
            let errorMessage = 'Erro ao salvar alterações.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            
            alert(errorMessage);
        },
        complete: function() {
            // Reabilitar botão
            $('#saveOrderBtn').prop('disabled', false).html('<i class="fas fa-save me-1"></i>Salvar Alterações');
        }
    });
}

// Função para abrir o WhatsApp após baixar o PDF da OS
function openWhatsAppAfterOSDownload(event, buttonElement) {
    // Não previne o comportamento padrão - deixa o PDF baixar
    
    // Pega os dados do botão
    const orderId = buttonElement.dataset.orderId;
    const clientName = buttonElement.dataset.clientName;
    const clientPhone = buttonElement.dataset.clientPhone;
    const description = buttonElement.dataset.description;
    
    // Aguarda 1 segundo para o download iniciar
    setTimeout(function() {
        // Mostra alerta de sucesso com instruções
        const alertHtml = `
            <div class="alert alert-info alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 350px; max-width: 400px;">
                <i class="fas fa-info-circle me-2"></i>
                <strong>PDF baixado!</strong><br>
                <small>Abrindo WhatsApp... Clique no ícone de anexo (📎) e selecione o PDF da OS #${orderId} que foi baixado.</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
        $('body').append(alertHtml);
        
        // Cria mensagem personalizada para o WhatsApp
        const fileName = `OS_${orderId}_${clientName.replace(/\s+/g, '_')}.pdf`;
        let whatsappMessage = `Olá! Segue em anexo a Ordem de Serviço #${orderId}`;
        
        if (description) {
            whatsappMessage += ` - ${description}`;
        }
        
        whatsappMessage += `\n\n📄 Arquivo: ${fileName}\n\nAtenciosamente,\nSAMAPE`;
        
        // Codifica a mensagem para URL
        const encodedMessage = encodeURIComponent(whatsappMessage);
        
        // Aguarda mais 800ms e abre o WhatsApp
        setTimeout(function() {
            let whatsappUrl;
            
            // Se tem telefone do cliente, abre direto para ele
            if (clientPhone && clientPhone.trim() !== '') {
                // Remove caracteres não numéricos do telefone
                const phoneNumber = clientPhone.replace(/\D/g, '');
                
                // Tenta abrir o WhatsApp com número e mensagem (app)
                whatsappUrl = `whatsapp://send?phone=55${phoneNumber}&text=${encodedMessage}`;
                const whatsappWindow = window.open(whatsappUrl, '_blank');
                
                // Fallback para WhatsApp Web
                setTimeout(function() {
                    if (!whatsappWindow || whatsappWindow.closed || typeof whatsappWindow.closed === 'undefined') {
                        whatsappUrl = `https://web.whatsapp.com/send?phone=55${phoneNumber}&text=${encodedMessage}`;
                        window.open(whatsappUrl, '_blank');
                    }
                }, 1500);
            } else {
                // Se não tem telefone, abre WhatsApp com mensagem genérica
                whatsappUrl = `whatsapp://send?text=${encodedMessage}`;
                const whatsappWindow = window.open(whatsappUrl, '_blank');
                
                // Fallback para WhatsApp Web
                setTimeout(function() {
                    if (!whatsappWindow || whatsappWindow.closed || typeof whatsappWindow.closed === 'undefined') {
                        whatsappUrl = `https://web.whatsapp.com/send?text=${encodedMessage}`;
                        window.open(whatsappUrl, '_blank');
                    }
                }, 1500);
            }
        }, 800);
        }, 500);
    }, 1000);
}
</script>
{% endblock %}

