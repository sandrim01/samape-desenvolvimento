{% extends "base.html" %}

{% block title %}Controle de Ponto - SAMAPE{% endblock %}

{% block content %}
<!-- Mobile Page Header -->
<div class="mobile-page-header">
    <div class="mobile-header-content">
        <h1 class="mobile-page-title">
            <i class="fas fa-clock me-2"></i>Controle de Ponto
        </h1>
        <div class="mobile-header-actions">
            {% if current_user.is_admin() or current_user.is_manager() %}
            <!-- Desktop Actions -->
            <div class="d-none d-md-flex">
                <a href="{{ url_for('ponto.admin_view') }}" class="btn btn-info me-2">
                    <i class="fas fa-users me-1"></i> Visão Geral
                </a>
                <a href="{{ url_for('ponto.relatorio') }}" class="btn btn-secondary">
                    <i class="fas fa-chart-bar me-1"></i> Relatórios
                </a>
            </div>
            
            <!-- Mobile Actions -->
            <div class="d-md-none">
                <div class="btn-group">
                    <button class="mobile-action-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('ponto.admin_view') }}">
                            <i class="fas fa-users me-2"></i>Visão Geral
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('ponto.relatorio') }}">
                            <i class="fas fa-chart-bar me-2"></i>Relatórios
                        </a></li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="content">
    <div class="container-fluid">
        <!-- Status do Ponto Hoje -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-day me-2"></i>Status de Hoje - {{ hoje.strftime('%d/%m/%Y') }}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                {% if ponto_hoje %}
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-sign-in-alt text-success me-2"></i>
                                                <strong>Entrada:</strong>
                                                <span class="ms-2 badge bg-success">
                                                    {{ ponto_hoje.hora_entrada.strftime('%H:%M') }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            {% if ponto_hoje.hora_saida %}
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-sign-out-alt text-danger me-2"></i>
                                                    <strong>Saída:</strong>
                                                    <span class="ms-2 badge bg-danger">
                                                        {{ ponto_hoje.hora_saida.strftime('%H:%M') }}
                                                    </span>
                                                </div>
                                            {% else %}
                                                <div class="d-flex align-items-center mb-2">
                                                    <i class="fas fa-clock text-warning me-2"></i>
                                                    <span class="text-warning">Aguardando saída</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if ponto_hoje.observacao %}
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <i class="fas fa-sticky-note me-1"></i>
                                            {{ ponto_hoje.observacao }}
                                        </small>
                                    </div>
                                    {% endif %}
                                {% else %}
                                    <div class="text-center text-muted">
                                        <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                        <p class="mb-0">Você ainda não registrou ponto hoje</p>
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 text-center">
                                {% if not ponto_hoje %}
                                    <button type="button" class="btn btn-success btn-lg" onclick="baterPonto('entrada')">
                                        <i class="fas fa-sign-in-alt me-2"></i>Registrar Entrada
                                    </button>
                                {% elif not ponto_hoje.hora_saida %}
                                    <button type="button" class="btn btn-danger btn-lg" onclick="baterPonto('saida')">
                                        <i class="fas fa-sign-out-alt me-2"></i>Registrar Saída
                                    </button>
                                {% else %}
                                    <div class="alert alert-success mb-0">
                                        <i class="fas fa-check-circle me-2"></i>
                                        Ponto completo para hoje!
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Histórico de Registros -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-history me-2"></i>Histórico de Registros
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if registros %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th width="100">Data</th>
                                        <th>Entrada</th>
                                        <th>Saída</th>
                                        <th>Horas Trabalhadas</th>
                                        <th class="d-none d-md-table-cell">Localização</th>
                                        <th>Observações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for registro in registros %}
                                    <tr>
                                        <td>
                                            <span class="badge bg-secondary">
                                                {{ registro.data.strftime('%d/%m') }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if registro.hora_entrada %}
                                                <span class="text-success">
                                                    <i class="fas fa-sign-in-alt me-1"></i>
                                                    {{ registro.hora_entrada.strftime('%H:%M') }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if registro.hora_saida %}
                                                <span class="text-danger">
                                                    <i class="fas fa-sign-out-alt me-1"></i>
                                                    {{ registro.hora_saida.strftime('%H:%M') }}
                                                </span>
                                            {% else %}
                                                <span class="text-warning">
                                                    <i class="fas fa-clock me-1"></i>Em andamento
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if registro.hora_entrada and registro.hora_saida %}
                                                {% set duracao = registro.hora_saida - registro.hora_entrada %}
                                                {% set horas = (duracao.total_seconds() / 3600) | round(2) %}
                                                <span class="badge bg-info">{{ horas }}h</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="d-none d-md-table-cell">
                                            {% if registro.latitude and registro.longitude %}
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>
                                                    {{ "%.4f" | format(registro.latitude) }}, {{ "%.4f" | format(registro.longitude) }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if registro.observacao %}
                                                <small>{{ registro.observacao[:50] }}{% if registro.observacao|length > 50 %}...{% endif %}</small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum registro de ponto encontrado.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Registrar Ponto -->
<div class="modal fade" id="pontoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pontoModalTitle">Registrar Ponto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="pontoForm" action="{{ url_for('ponto.bater_ponto') }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <input type="hidden" name="latitude" id="latitude">
                <input type="hidden" name="longitude" id="longitude">
                
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="observacao" class="form-label">Observações (opcional)</label>
                        <textarea class="form-control" id="observacao" name="observacao" rows="3" placeholder="Digite alguma observação sobre este registro..."></textarea>
                    </div>
                    
                    <div id="locationStatus" class="alert alert-info">
                        <i class="fas fa-location-arrow me-2"></i>
                        Obtendo localização...
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                        <i class="fas fa-clock me-2"></i>Registrar Ponto
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function baterPonto(tipo) {
    document.getElementById('pontoModalTitle').textContent = 
        tipo === 'entrada' ? 'Registrar Entrada' : 'Registrar Saída';
    
    // Obter localização
    if (navigator.geolocation) {
        document.getElementById('locationStatus').innerHTML = 
            '<i class="fas fa-spinner fa-spin me-2"></i>Obtendo localização...';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                document.getElementById('latitude').value = position.coords.latitude;
                document.getElementById('longitude').value = position.coords.longitude;
                document.getElementById('locationStatus').innerHTML = 
                    '<i class="fas fa-check-circle text-success me-2"></i>Localização obtida com sucesso!';
                document.getElementById('submitBtn').disabled = false;
            },
            function(error) {
                document.getElementById('locationStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle text-warning me-2"></i>Não foi possível obter a localização. Você pode continuar mesmo assim.';
                document.getElementById('submitBtn').disabled = false;
            }
        );
    } else {
        document.getElementById('locationStatus').innerHTML = 
            '<i class="fas fa-exclamation-triangle text-warning me-2"></i>Geolocalização não suportada neste navegador.';
        document.getElementById('submitBtn').disabled = false;
    }
    
    // Exibir modal
    new bootstrap.Modal(document.getElementById('pontoModal')).show();
}
</script>
{% endblock %}
