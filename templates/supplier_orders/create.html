{% extends "base.html" %}

{% block title %}Novo Pedido a Fornecedor - SAMAPE{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Novo Pedido a Fornecedor</h1>
</div>

<div class="card">
    <div class="card-header">
        <i class="fas fa-plus me-1"></i> Cadastro de Pedido
    </div>
    <div class="card-body">
        <form method="post" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="supplier_id" class="form-label">Fornecedor *</label>
                    {{ form.supplier_id(class="form-control", id="supplier_id") }}
                    {% if form.supplier_id.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.supplier_id.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-6">
                    <label for="order_number" class="form-label">Número do Pedido</label>
                    {{ form.order_number(class="form-control", id="order_number") }}
                    {% if form.order_number.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.order_number.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="status" class="form-label">Status *</label>
                    {{ form.status(class="form-control", id="status") }}
                    {% if form.status.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.status.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="expected_delivery_date" class="form-label">Data Prevista de Entrega</label>
                    {{ form.expected_delivery_date(class="form-control", id="expected_delivery_date", placeholder="DD/MM/AAAA") }}
                    {% if form.expected_delivery_date.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.expected_delivery_date.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4">
                    <label for="total_value" class="form-label">Valor Total (R$) <small class="text-muted">(Calculado automaticamente)</small></label>
                    {{ form.total_value(class="form-control", id="total_value", placeholder="0,00", readonly=true) }}
                    {% if form.total_value.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.total_value.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="mb-3">
                <label for="notes" class="form-label">Observações</label>
                {{ form.notes(class="form-control", id="notes", rows=3) }}
                {% if form.notes.errors %}
                    <div class="invalid-feedback d-block">
                        {% for error in form.notes.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <!-- Tabela de itens do pedido -->
            <div class="card mt-4 mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-shopping-basket me-1"></i> Itens do Pedido</span>
                    <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                        <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="itemsTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Descrição</th>
                                    <th>Quantidade</th>
                                    <th>Preço Unit.</th>
                                    <th>Total</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="itemsList">
                                <tr id="noItemsRow">
                                    <td colspan="6" class="text-center">Nenhum item adicionado ao pedido</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">Total do Pedido:</td>
                                    <td id="orderTotalDisplay">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <button type="submit" class="btn btn-primary">Cadastrar Pedido</button>
                <a href="{{ url_for('supplier_orders') }}" class="btn btn-secondary ms-2">Cancelar</a>
            </div>
            
            <!-- Campo oculto para armazenar os itens como JSON -->
            <input type="hidden" name="items_json" id="itemsJson" value="[]">
        </form>
    </div>
</div>

<!-- Modal para Adicionar Item -->
<div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addItemModalLabel">Adicionar Item ao Pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="itemForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="itemPartId" class="form-label">Peça (opcional)</label>
                            <select class="form-select" id="itemPartId">
                                <option value="">Selecione uma peça ou digite a descrição</option>
                                {% for part in parts %}
                                <option value="{{ part.id }}" data-description="{{ part.name }}" data-price="{{ part.cost_price or 0 }}">
                                    {{ part.name }} - {{ part.part_number or 'S/N' }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="itemDescription" class="form-label">Descrição *</label>
                            <input type="text" class="form-control" id="itemDescription" required>
                            <div class="invalid-feedback">
                                Por favor, informe uma descrição para o item.
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="itemQuantity" class="form-label">Quantidade *</label>
                            <input type="number" class="form-control" id="itemQuantity" min="1" value="1" required>
                            <div class="invalid-feedback">
                                A quantidade deve ser maior que zero.
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label for="itemUnitPrice" class="form-label">Preço Unitário (R$)</label>
                            <input type="text" class="form-control" id="itemUnitPrice" placeholder="0,00">
                        </div>
                        
                        <div class="col-md-4">
                            <label for="itemTotalPrice" class="form-label">Preço Total (R$)</label>
                            <input type="text" class="form-control" id="itemTotalPrice" placeholder="0,00" readonly>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="addItemBtn">Adicionar Item</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variáveis globais
let orderItems = [];
let itemCounter = 0;

// Aguardar DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM carregado, inicializando scripts...');
    
    // Inicializar funções básicas
    initializeDateMasks();
    initializeMoneyMasks();
    initializePartSelection();
    initializeItemModal();
    
    console.log('Scripts inicializados com sucesso');
});

// Funções auxiliares
function formatCurrency(value) {
    if (!value || isNaN(value)) return 'R$ 0,00';
    return new Intl.NumberFormat('pt-BR', { 
        style: 'currency', 
        currency: 'BRL' 
    }).format(value);
}

function currencyToFloat(currencyStr) {
    if (!currencyStr) return 0;
    const cleanStr = currencyStr.toString().replace(/[^\d,.-]/g, '');
    return parseFloat(cleanStr.replace(',', '.')) || 0;
}

// Inicializar máscaras de data
function initializeDateMasks() {
    const dateFields = document.querySelectorAll('#expected_delivery_date, #delivery_date');
    dateFields.forEach(field => {
        field.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 8) value = value.substring(0, 8);
            
            if (value.length > 4) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4) + '/' + value.substring(4);
            } else if (value.length > 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            
            e.target.value = value;
        });
    });
}

// Inicializar máscaras de moeda
function initializeMoneyMasks() {
    const moneyFields = ['total_value', 'itemUnitPrice'];
    
    moneyFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value === '') {
                    e.target.value = '';
                    return;
                }
                
                value = parseFloat(value) / 100;
                e.target.value = value.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            });
        }
    });
    
    // Listener especial para calcular total do item
    const unitPriceField = document.getElementById('itemUnitPrice');
    const quantityField = document.getElementById('itemQuantity');
    
    if (unitPriceField) {
        unitPriceField.addEventListener('input', calculateItemTotal);
    }
    
    if (quantityField) {
        quantityField.addEventListener('input', calculateItemTotal);
    }
}

// Inicializar seleção de peça
function initializePartSelection() {
    const partSelect = document.getElementById('itemPartId');
    if (partSelect) {
        partSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                const description = selectedOption.getAttribute('data-description') || '';
                const price = selectedOption.getAttribute('data-price') || '0';
                
                document.getElementById('itemDescription').value = description;
                
                if (price && !isNaN(parseFloat(price))) {
                    const formattedPrice = parseFloat(price).toLocaleString('pt-BR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('itemUnitPrice').value = formattedPrice;
                }
                
                calculateItemTotal();
            }
        });
    }
}

// Calcular total do item
function calculateItemTotal() {
    const quantityField = document.getElementById('itemQuantity');
    const unitPriceField = document.getElementById('itemUnitPrice');
    const totalPriceField = document.getElementById('itemTotalPrice');
    
    if (!quantityField || !unitPriceField || !totalPriceField) return;
    
    const quantity = parseInt(quantityField.value) || 0;
    const unitPrice = currencyToFloat(unitPriceField.value);
    const totalPrice = quantity * unitPrice;
    
    totalPriceField.value = totalPrice.toLocaleString('pt-BR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Inicializar modal de item
function initializeItemModal() {
    const addItemBtn = document.getElementById('addItemBtn');
    if (!addItemBtn) {
        console.error('Botão addItemBtn não encontrado');
        return;
    }
    
    addItemBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('=== INICIANDO ADIÇÃO DE ITEM ===');
        
        // Desabilitar botão temporariamente para evitar clicks duplos
        addItemBtn.disabled = true;
        addItemBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        
        setTimeout(() => {
            try {
                console.log('1. Coletando dados do formulário...');
                
                // Pegar valores dos campos
                const partId = document.getElementById('itemPartId')?.value || '';
                const description = document.getElementById('itemDescription')?.value?.trim() || '';
                const quantity = parseInt(document.getElementById('itemQuantity')?.value) || 0;
                const unitPrice = currencyToFloat(document.getElementById('itemUnitPrice')?.value || '0');
                const totalPrice = currencyToFloat(document.getElementById('itemTotalPrice')?.value || '0');
                
                console.log('2. Dados coletados:', { partId, description, quantity, unitPrice, totalPrice });
                
                // Validar
                if (!description) {
                    alert('Por favor, informe a descrição do item.');
                    resetButton();
                    return;
                }
                
                if (quantity <= 0) {
                    alert('A quantidade deve ser maior que zero.');
                    resetButton();
                    return;
                }
                
                console.log('3. Validação passou, criando item...');
                
                // Criar item
                itemCounter++;
                const newItem = {
                    id: itemCounter,
                    part_id: partId || null,
                    description: description,
                    quantity: quantity,
                    unit_price: unitPrice,
                    total_price: totalPrice
                };
                
                console.log('4. Item criado:', newItem);
                
                // Adicionar ao array
                orderItems.push(newItem);
                console.log('5. Array atualizado. Total de itens:', orderItems.length);
                
                // Atualizar interface
                console.log('6. Atualizando tabela...');
                updateItemsTable();
                
                console.log('7. Atualizando total...');
                updateOrderTotal();
                
                console.log('8. Limpando formulário...');
                clearItemForm();
                
                console.log('9. Fechando modal...');
                closeModal();
                
                console.log('=== ITEM ADICIONADO COM SUCESSO ===');
                
                // Mostrar feedback visual
                const feedback = document.createElement('div');
                feedback.className = 'alert alert-success alert-dismissible fade show position-fixed';
                feedback.style.top = '20px';
                feedback.style.right = '20px';
                feedback.style.zIndex = '9999';
                feedback.innerHTML = `
                    <i class="fas fa-check"></i> Item "${description}" adicionado com sucesso!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(feedback);
                
                // Remover feedback após 3 segundos
                setTimeout(() => {
                    if (feedback && feedback.parentNode) {
                        feedback.remove();
                    }
                }, 3000);
                
            } catch (error) {
                console.error('ERRO ao adicionar item:', error);
                alert('Erro ao adicionar item: ' + error.message);
            } finally {
                resetButton();
            }
        }, 100); // Pequeno delay para evitar travamentos
        
        function resetButton() {
            addItemBtn.disabled = false;
            addItemBtn.innerHTML = 'Adicionar Item';
        }
    });
}

// Atualizar tabela de itens
function updateItemsTable() {
    try {
        console.log('Iniciando atualização da tabela...');
        
        const tbody = document.getElementById('itemsList');
        if (!tbody) {
            console.error('Elemento itemsList não encontrado');
            return;
        }
        
        // Limpar tabela
        tbody.innerHTML = '';
        
        if (orderItems.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Nenhum item adicionado ao pedido</td></tr>';
            console.log('Tabela limpa - nenhum item');
            return;
        }
        
        // Adicionar itens um por um
        orderItems.forEach((item, index) => {
            try {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.description || 'N/A'}</td>
                    <td>${item.quantity || 0}</td>
                    <td>${formatCurrency(parseFloat(item.unit_price) || 0)}</td>
                    <td>${formatCurrency(parseFloat(item.total_price) || 0)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${item.id})" title="Remover item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                console.log(`Item ${index + 1} adicionado à tabela`);
            } catch (itemError) {
                console.error(`Erro ao adicionar item ${index + 1} à tabela:`, itemError);
            }
        });
        
        // Atualizar campo oculto
        try {
            const itemsJsonField = document.getElementById('itemsJson');
            if (itemsJsonField) {
                itemsJsonField.value = JSON.stringify(orderItems);
                console.log('Campo JSON atualizado');
            } else {
                console.warn('Campo itemsJson não encontrado');
            }
        } catch (jsonError) {
            console.error('Erro ao atualizar JSON:', jsonError);
        }
        
        console.log(`Tabela atualizada com ${orderItems.length} itens`);
        
    } catch (error) {
        console.error('ERRO CRÍTICO ao atualizar tabela:', error);
        // Fallback simples
        const tbody = document.getElementById('itemsList');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Erro ao carregar itens</td></tr>';
        }
    }
}

// Atualizar total do pedido
function updateOrderTotal() {
    const total = orderItems.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0);
    
    const orderTotalDisplay = document.getElementById('orderTotalDisplay');
    const totalValueField = document.getElementById('total_value');
    
    if (orderTotalDisplay) {
        orderTotalDisplay.textContent = formatCurrency(total);
    }
    
    if (totalValueField) {
        // Para campos input[type="number"], usar ponto como separador decimal
        totalValueField.value = total.toFixed(2);
    }
}

// Limpar formulário do item
function clearItemForm() {
    const fields = ['itemPartId', 'itemDescription', 'itemQuantity', 'itemUnitPrice', 'itemTotalPrice'];
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (fieldId === 'itemQuantity') {
                field.value = '1';
            } else {
                field.value = '';
            }
        }
    });
}

// Fechar modal
function closeModal() {
    try {
        const modal = document.getElementById('addItemModal');
        if (modal) {
            // Tentar múltiplas formas de fechar o modal
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            } else {
                // Fallback: fechar manualmente
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                modal.removeAttribute('aria-modal');
                modal.removeAttribute('role');
                
                // Remover backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }
                
                // Restaurar scroll do body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }
        }
        console.log('Modal fechado com sucesso');
    } catch (error) {
        console.error('Erro ao fechar modal:', error);
        // Forçar fechamento manual
        const modal = document.getElementById('addItemModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) backdrop.remove();
        }
    }
}

// Remover item (função global)
window.removeItem = function(itemId) {
    orderItems = orderItems.filter(item => item.id !== itemId);
    updateItemsTable();
    updateOrderTotal();
};
</script>
{% endblock %}