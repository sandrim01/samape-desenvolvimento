<!-- Modal para bater ponto -->
<div class="modal fade" id="modalBaterPonto" tabindex="-1" aria-labelledby="modalBaterPontoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalBaterPontoLabel"><i class="fas fa-camera me-2"></i>Bater Ponto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="form-bater-ponto" method="post" enctype="multipart/form-data" action="{{ url_for('ponto.bater_ponto') }}">
          <div class="mb-3 text-center">
            <video id="video" width="100%" height="240" autoplay playsinline style="border-radius: 10px; background: #222;"></video>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
          </div>
          <input type="hidden" name="foto" id="foto-base64">
          <button type="button" class="btn btn-primary w-100 mb-2" id="btn-capturar">Capturar Foto</button>
          <button type="submit" class="btn btn-success w-100" id="btn-enviar" disabled>Registrar Ponto</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Abrir modal e iniciar cÃ¢mera
const modalBaterPonto = document.getElementById('modalBaterPonto');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnCapturar = document.getElementById('btn-capturar');
const btnEnviar = document.getElementById('btn-enviar');
const fotoBase64 = document.getElementById('foto-base64');

let stream;

if (modalBaterPonto) {
  modalBaterPonto.addEventListener('show.bs.modal', async function () {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      btnEnviar.disabled = true;
      fotoBase64.value = '';
      canvas.style.display = 'none';
      video.style.display = 'block';
    }
  });
  modalBaterPonto.addEventListener('hidden.bs.modal', function () {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
  });
}

if (btnCapturar) {
  btnCapturar.addEventListener('click', function (e) {
    e.preventDefault();
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    fotoBase64.value = canvas.toDataURL('image/png');
    canvas.style.display = 'block';
    video.style.display = 'none';
    btnEnviar.disabled = false;
  });
}
</script>
